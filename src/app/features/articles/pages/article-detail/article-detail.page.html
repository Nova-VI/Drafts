<main class="container">
  <header class="header">
    <div>
      <a class="btn ghost" [routerLink]="['/articles']">← Back</a>
      <h1 class="pageTitle">
        @if(article()){
                  {{article()!.title}}
        }
        @else{
                  Article Not Found
        }

      </h1>
      <p class="subTitle">Dummy data</p>
    </div>
  </header>

  @if (article()) {
    <article class="card detail">
      <div class="meta">
        <span class="author">{{ article()!.owner }}</span>
        <span class="dot">•</span>
        <time class="date">{{ article()!.createdAt | date: 'medium' }}</time>
        <span class="dot">•</span>
        <span class="comments">{{ commentCount() }} comments</span>
      </div>

      <h2 class="cardTitle">{{ article()!.title }}</h2>

      <div class="body">
        <p class="content">{{ article()!.content }}</p>
        
        @if (article()!.images && article()!.images.length > 0) {
          <div class="imagesGallery">
            @for (image of article()!.images; track image) {
              <div class="imageTile" (click)="openLightbox(image)" [style.--bg-image]="'url(' + image + ')'">
                <img [src]="image" [alt]="article()!.title" class="articleImage" />
              </div>
            }
          </div>
        }
      </div>

      <div class="actions" aria-label="Reactions">
        <button
          type="button"
          class="btn voteBtn"
          [class.active]="store.isUpvoted(article()!)"
          (click)="store.upvote(article()!.id)"
          aria-label="Like"
        >
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 11V20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M6 11h4l5.4-6.3c.6-.7 1.7-.2 1.6.7l-.7 5.6H20a2 2 0 0 1 2 2.2l-1.1 7A2 2 0 0 1 18.9 22H10a4 4 0 0 1-4-4v-7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="label">
            <span class="count">{{ article()!.upvotes }}</span>
          </span>
        </button>

        <button
          type="button"
          class="btn voteBtn"
          [class.activeDown]="store.isDownvoted(article()!)"
          (click)="store.downvote(article()!.id)"
          aria-label="Dislike"
        >
          <span class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14 13V4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <path d="M18 13h-4L8.6 19.3c-.6.7-1.7.2-1.6-.7l.7-5.6H4a2 2 0 0 1-2-2.2l1.1-7A2 2 0 0 1 5.1 2H14a4 4 0 0 1 4 4v7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="label">
            <span class="count">{{ article()!.downvotes }}</span>
          </span>
        </button>

          <button type="button" class="btn dangerBtn" (click)="deleteThisArticle()">Delete</button>
      </div>

      <div class="divider" role="separator" aria-hidden="true"></div>

      <section class="commentsSection" aria-label="Comments">
        @if(!hasComments()) {
          <p class="muted noComments">No comments yet. Be the first to comment!</p>
        }
        <div class="commentsHeader">
          <h3 class="sectionTitle">Comments</h3>
          <p class="muted countLine">{{ commentCount() }} comments</p>
        </div>

        <form class="composer" (submit)="$event.preventDefault(); addRootComment()">
          <textarea
            class="input composerInput"
            rows="3"
            placeholder="Write a comment…"
            [value]="newCommentText()"
            (input)="newCommentText.set(($any($event.target).value))"
            (paste)="handlePaste($event, 'root')"
          ></textarea>
          
          @if (newCommentImagePreviews().length > 0) {
            <div class="commentImagePreviews">
              @for (preview of newCommentImagePreviews(); let i = $index; track preview.name) {
                <div class="commentImagePreview">
                  <img [src]="preview.url" [alt]="preview.name" />
                  <button
                    type="button"
                    class="btn removeCommentImageBtn"
                    (click)="removeRootCommentImage(i)"
                    aria-label="Remove image"
                  >
                    ✕
                  </button>
                </div>
              }
            </div>
          }
          
          <div class="composerActions">
            <input
              type="file"
              multiple
              accept="image/*"
              class="composerFileInput"
              (change)="onRootCommentImageSelect($event)"
              [disabled]="newCommentImages().length >= 5"
              aria-label="Add images to comment"
            />
            <button type="submit" class="btn">Post comment</button>
          </div>
        </form>

        @if (hasComments()) {
          <ng-template #thread let-items>
            <div class="commentsList" role="list">
              @for (c of items; track c.id) {
                <article class="comment" role="listitem">
                  <div class="commentMeta">
                    <span class="author">{{ c.owner }}</span>
                    <span class="dot">•</span>
                    <time class="date">{{ c.createdAt | date: 'mediumDate' }}</time>
                  </div>

                  <p class="commentBody">{{ c.content }}</p>

                  @if (c.images && c.images.length > 0) {
                    <div class="commentImagesGallery">
                      @for (image of c.images; track image) {
                        <div class="commentImageTile" (click)="openLightbox(image)" [style.--bg-image]="'url(' + image + ')'">
                          <img [src]="image" [alt]="c.title" class="commentImage" />
                        </div>
                      }
                    </div>
                  }

                  <div class="commentActions" aria-label="Comment actions">
                    <button
                      type="button"
                      class="btn voteBtn miniBtn"
                      [class.active]="store.isUpvoted(c)"
                      (click)="store.upvote(c.id)"
                      aria-label="Like comment"
                    >
                      <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M10 11V20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                          <path d="M6 11h4l5.4-6.3c.6-.7 1.7-.2 1.6.7l-.7 5.6H20a2 2 0 0 1 2 2.2l-1.1 7A2 2 0 0 1 18.9 22H10a4 4 0 0 1-4-4v-7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                        </svg>
                      </span>
                      <span class="label"><span class="count">{{ c.upvotes }}</span></span>
                    </button>

                    <button
                      type="button"
                      class="btn voteBtn miniBtn"
                      [class.activeDown]="store.isDownvoted(c)"
                      (click)="store.downvote(c.id)"
                      aria-label="Dislike comment"
                    >
                      <span class="icon" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M14 13V4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                          <path d="M18 13h-4L8.6 19.3c-.6.7-1.7.2-1.6-.7l.7-5.6H4a2 2 0 0 1-2-2.2l1.1-7A2 2 0 0 1 5.1 2H14a4 4 0 0 1 4 4v7Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                        </svg>
                      </span>
                      <span class="label"><span class="count">{{ c.downvotes }}</span></span>
                    </button>

                    <button type="button" class="btn miniBtn replyBtn" (click)="startReply(c.id)">
                      Reply
                    </button>
                  </div>

                  @if (replyingTo() === c.id) {
                    <form class="replyForm" (submit)="$event.preventDefault(); submitReply(c.id)">
                      <textarea
                        class="input replyInput"
                        rows="3"
                        placeholder="Write a reply…"
                        [value]="replyText()"
                        (input)="replyText.set(($any($event.target).value))"
                        (paste)="handlePaste($event, 'reply')"
                      ></textarea>
                      
                      @if (replyImagePreviews().length > 0) {
                        <div class="commentImagePreviews">
                          @for (preview of replyImagePreviews(); let i = $index; track preview.name) {
                                <div class="commentImagePreview">
                                  <img [src]="preview.url" [alt]="preview.name" />
                                  <button
                                    type="button"
                                    class="btn removeCommentImageBtn"
                                    (click)="removeReplyImage(i)"
                                    aria-label="Remove image"
                                  >
                                    ✕
                                  </button>
                                </div>
                              }
                        </div>
                      }
                      
                      <div class="replyActions">
                        <input
                          type="file"
                          multiple
                          accept="image/*"
                          class="composerFileInput"
                          (change)="onReplyImageSelect($event)"
                          [disabled]="replyImages().length >= 5"
                          aria-label="Add images to reply"
                        />
                        <button type="submit" class="btn">Reply</button>
                        <button type="button" class="btn" (click)="cancelReply()">Cancel</button>
                      </div>
                    </form>
                  }

                  @if ((c.comments ?? []).length > 0) {
                    <div class="replies">
                      <ng-container *ngTemplateOutlet="thread; context: { $implicit: c.comments }"></ng-container>
                    </div>
                  }
                </article>
              }
            </div>
          </ng-template>

          <ng-container *ngTemplateOutlet="thread; context: { $implicit: articleComments() }"></ng-container>
        }
      </section>
    </article>
  }

          @if (lightboxImage()) {
            <div class="lightboxOverlay" (click)="closeLightbox()">
              <img [src]="lightboxImage()" alt="preview" (click)="$event.stopPropagation()" />
            </div>
          }
</main>
